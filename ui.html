<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Tessa - Figma Analyzer</title>
  <style>
    body {
      font-family: Inter, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f9fafb;
      color: #111;
    }
    h2 { margin-bottom: 8px; }
    button {
      background: #007aff;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #005fcc; }
    .section { margin-top: 20px; }
    #output {
      margin-top: 16px;
      padding: 12px;
      background: #f0f0f0;
      border-radius: 6px;
      font-size: 13px;
      white-space: pre-wrap;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>Tessa – Figma File Analyzer</h2>
  <button id="analyzeSelectionBtn">Analyze Figma File</button>

  <div id="status" class="section hidden"></div>
  <div id="summary" class="section hidden"></div>
  <div id="output" class="section hidden"></div>

  <script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const GEMINI_API_KEY = "AIzaSyAW311hX7VGzc7yvQzYhQSza2CiP7fGZKw"; // replace dynamically
    let genAI;

    function initGemini() {
      if (!GEMINI_API_KEY || GEMINI_API_KEY === "{{GEMINI_API_KEY}}") {
        showStatus("Missing Gemini API key in .env", true);
        return false;
      }
      genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
      return true;
    }

    const elements = {
      analyzeSelectionBtn: document.getElementById("analyzeSelectionBtn"),
      status: document.getElementById("status"),
      summary: document.getElementById("summary"),
      output: document.getElementById("output")
    };

    elements.analyzeSelectionBtn.onclick = () => {
      if (!initGemini()) return;
      showStatus("Analyzing entire file...", false);
      parent.postMessage({ pluginMessage: { type: "analyze-file" } }, "*");
    };

    onmessage = async (event) => {
      const msg = event.data.pluginMessage;
      if (!msg) return;

      if (msg.type === "fileData") {
        showStatus("Generating AI analysis...", false);
        const data = msg.data;
        await analyzeWithGemini(data);
      } else if (msg.type === "error") {
        showStatus("Error: " + msg.message, true);
      }
    };

    function showStatus(text, isError) {
      elements.status.textContent = text;
      elements.status.classList.remove("hidden");
      elements.status.style.color = isError ? "red" : "#333";
    }

    async function analyzeWithGemini(data) {
      try {
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
        const prompt = `
You are analyzing a Figma file structure. Summarize its structure, hierarchy, and UI/UX design patterns.
Suggest improvements based on the data below:

${JSON.stringify(data, null, 2)}
        `;
        const result = await model.generateContent(prompt);
        const text = result.response.text();

        elements.summary.classList.remove("hidden");
        elements.output.classList.remove("hidden");
        elements.output.textContent = text;
        showStatus("✅ Analysis complete", false);
      } catch (err) {
        showStatus("Gemini API error: " + err.message, true);
      }
    }
  </script>
</body>
</html>
